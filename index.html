
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>CSE AixMobil</title>

    <style>
      .highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight .gh {
  color: #999999;
}
.highlight .sr {
  color: #f6aa11;
}
.highlight .go {
  color: #888888;
}
.highlight .gp {
  color: #555555;
}
.highlight .gs {
}
.highlight .gu {
  color: #aaaaaa;
}
.highlight .nb {
  color: #f6aa11;
}
.highlight .cm {
  color: #75715e;
}
.highlight .cp {
  color: #75715e;
}
.highlight .c1 {
  color: #75715e;
}
.highlight .cs {
  color: #75715e;
}
.highlight .c, .highlight .cd {
  color: #75715e;
}
.highlight .err {
  color: #960050;
}
.highlight .gr {
  color: #960050;
}
.highlight .gt {
  color: #960050;
}
.highlight .gd {
  color: #49483e;
}
.highlight .gi {
  color: #49483e;
}
.highlight .ge {
  color: #49483e;
}
.highlight .kc {
  color: #66d9ef;
}
.highlight .kd {
  color: #66d9ef;
}
.highlight .kr {
  color: #66d9ef;
}
.highlight .no {
  color: #66d9ef;
}
.highlight .kt {
  color: #66d9ef;
}
.highlight .mf {
  color: #ae81ff;
}
.highlight .mh {
  color: #ae81ff;
}
.highlight .il {
  color: #ae81ff;
}
.highlight .mi {
  color: #ae81ff;
}
.highlight .mo {
  color: #ae81ff;
}
.highlight .m, .highlight .mb, .highlight .mx {
  color: #ae81ff;
}
.highlight .sc {
  color: #ae81ff;
}
.highlight .se {
  color: #ae81ff;
}
.highlight .ss {
  color: #ae81ff;
}
.highlight .sd {
  color: #e6db74;
}
.highlight .s2 {
  color: #e6db74;
}
.highlight .sb {
  color: #e6db74;
}
.highlight .sh {
  color: #e6db74;
}
.highlight .si {
  color: #e6db74;
}
.highlight .sx {
  color: #e6db74;
}
.highlight .s1 {
  color: #e6db74;
}
.highlight .s {
  color: #e6db74;
}
.highlight .na {
  color: #a6e22e;
}
.highlight .nc {
  color: #a6e22e;
}
.highlight .nd {
  color: #a6e22e;
}
.highlight .ne {
  color: #a6e22e;
}
.highlight .nf {
  color: #a6e22e;
}
.highlight .vc {
  color: #ffffff;
}
.highlight .nn {
  color: #ffffff;
}
.highlight .nl {
  color: #ffffff;
}
.highlight .ni {
  color: #ffffff;
}
.highlight .bp {
  color: #ffffff;
}
.highlight .vg {
  color: #ffffff;
}
.highlight .vi {
  color: #ffffff;
}
.highlight .nv {
  color: #ffffff;
}
.highlight .w {
  color: #ffffff;
}
.highlight {
  color: #ffffff;
}
.highlight .n, .highlight .py, .highlight .nx {
  color: #ffffff;
}
.highlight .ow {
  color: #f92672;
}
.highlight .nt {
  color: #f92672;
}
.highlight .k, .highlight .kv {
  color: #f92672;
}
.highlight .kn {
  color: #f92672;
}
.highlight .kp {
  color: #f92672;
}
.highlight .o {
  color: #f92672;
}
    </style>
    <link href="stylesheets/screen.css" rel="stylesheet" media="screen" />
    <link href="stylesheets/print.css" rel="stylesheet" media="print" />
      <script src="javascripts/all.js"></script>
  </head>

  <body class="index" data-languages="[&quot;javascript&quot;]">
    <a href="#" id="nav-button">
      <span>
        NAV
        <img src="images/navbar.png" alt="Navbar" />
      </span>
    </a>
    <div class="toc-wrapper">
      <img src="images/logo.png" class="logo" alt="Logo" />
        <div class="lang-selector">
              <a href="#" data-language-name="javascript">javascript</a>
        </div>
        <div class="search">
          <input type="text" class="search" id="input-search" placeholder="Search">
        </div>
        <ul class="search-results"></ul>
      <ul id="toc" class="toc-list-h1">
          <li>
            <a href="#introducao" class="toc-h1 toc-link" data-title="Introdução">Introdução</a>
          </li>
          <li>
            <a href="#pre-requisitos" class="toc-h1 toc-link" data-title="Pré-requisitos">Pré-requisitos</a>
          </li>
          <li>
            <a href="#instalacao" class="toc-h1 toc-link" data-title="Instalação">Instalação</a>
          </li>
          <li>
            <a href="#configuracao" class="toc-h1 toc-link" data-title="Configuração">Configuração</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#submit-com-requisicao-ajax" class="toc-h2 toc-link" data-title="Submit com requisição AJAX">Submit com requisição AJAX</a>
                  </li>
                  <li>
                    <a href="#submit-com-atributo-action-e-method" class="toc-h2 toc-link" data-title="Submit com atributo action e method">Submit com atributo action e method</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#validacao-da-transacao" class="toc-h1 toc-link" data-title="Validação da transação">Validação da transação</a>
          </li>
      </ul>
    </div>
    <div class="page-wrapper">
      <div class="dark-box"></div>
      <div class="content">
        <h1 id='introducao'>Introdução</h1>
<p><strong>Bem-vindo à biblioteca de Checkout de Pagamento Seguro da AixMobil!</strong></p>

<p>Ela fornece uma camada extra de segurança para o portador do cartão, garantindo que os dados informados na hora do pagamento trafeguem de forma encriptada até chegarem aos nossos servidores para que a transação seja processada.</p>

<p>Encriptar os dados significa que os dados originais do cartão não ficam visíveis para que pessoas mal-intencionadas possam copiá-los e utilizá-los para realizar outras transações ou que tais dados não sejam expostos em caso de uma brecha de segurança durante o fluxo dos dados.</p>

<p>A biblioteca implementa a técnica <a target="_blank" href="https://en.wikipedia.org/wiki/Client-side_encryption">Client-side encription (CSE)</a> e é aderente às exigências definidas pelo <a target="_blank" href="https://en.wikipedia.org/wiki/Payment_Card_Industry_Data_Security_Standard">PCI-DSS</a>.</p>

<p>Os passos abaixo explicam como integrar <span class="keyword">client-side encription</span> a sua página de pagamento utilizando Javascript.</p>
<h1 id='pre-requisitos'>Pré-requisitos</h1>
<p>A técnica de CSE utiliza-se do sistema de criptografia RSA, baseado em um par de chaves para encriptar e decriptar os dados sensíveis do pagamento.</p>

<p>Para cada site de pagamento deve existir apenas um par de chaves.</p>

<p><strong>A chave pública</strong>, representada por uma string, deve ser informada para a biblioteca durante a inicialização da página, por exemplo.</p>

<p><strong>O hostname</strong>, representado por uma string, é o hostname do serviço que será chamado para a obtenção do token de criptografia. Ela deve ser solicitada à AixMobil junto com a chave pública durante a configuração do formulário de checkout.</p>

<p><strong>A chave privada</strong> é armazenada dentro de um ambiente de seguro na infra-estrutura da <span class="aixmobil">AixMobil</span> e nunca é transmitida ou acessível a qualquer pessoa. Ela é utilizada apenas pela plataforma para decriptar os dados recebidos.</p>

<p><strong>Para solicitar um novo par de chaves para um determinado site, enviar um e-mail para <a href="mailto:suporte@aixmobil.com">suporte@aixmobil.com</a> informando os seguintes dados:</strong></p>

<ul>
<li>Nome da pessoa física ou Razão Social (empresa)</li>
<li>CPF ou CNPJ</li>
<li>Domínio do site (ex: http://www.meusite.com.br)</li>
</ul>
<h1 id='instalacao'>Instalação</h1><pre class="highlight html tab-html"><code><span class="nt">&lt;body&gt;</span>
  ...
  <span class="c">&lt;!-- Ambiente de produção --&gt;</span>
  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"https://payment.aixmobil.com.br/resources/cse/js/aixmobil-cse-1.1.0.min.js"</span><span class="nt">&gt;&lt;/script&gt;</span>

  <span class="c">&lt;!-- Ambiente de teste --&gt;</span>
  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"https://dev.aixmobil.com.br/resources/cse/js/aixmobil-cse-1.1.0.min.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;/body&gt;</span>
</code></pre>
<p>Referenciar o script da biblioteca no HTML do site.</p>

<p>É importante referenciar o script externo ao invés de criar uma cópia do script para dentro do site, uma vez que a biblioteca poderá ser alterada a qualquer momento, podendo gerar problemas para aprovar a transação.</p>
<h1 id='configuracao'>Configuração</h1>
<p>Todos os desenvolvimentos de integração devem ser feitos utilizando os endpoints do ambiente de <span class="keyword">Testes</span> da <span class="aixmobil">AixMobil</span> e apenas direcionados para <span class="keyword">Produção</span> quando as integrações estiverem finalizadas.</p>

<p><strong>Host de testes</strong>: <code>https://api-dev.aixmobil.com/api/</code></p>

<p><strong>Host de produção</strong>: <code>https://api.aixmobil.com/api/</code></p>

<p>O site pode ter sido desenvolvido para enviar os dados do formulário de duas formas diferentes: usando alguma biblioteca ou framework que intercepta o evento de submit do form e realiza uma chamada AJAX internamente ou utilizando o recurso nativo do elemento <code>FORM</code>, através dos atributos <code>method</code> e <code>action</code>.</p>
<h2 id='submit-com-requisicao-ajax'>Submit com requisição AJAX</h2><pre class="highlight javascript tab-javascript"><code><span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span>
  <span class="nb">window</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">publicKey</span> <span class="o">=</span> <span class="s1">'[CHAVE_PUBLICA_AQUI]'</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">hostName</span> <span class="o">=</span> <span class="s1">'[HOST_NAME_DO_SERVICO_AQUI]'</span><span class="p">;</span>

      <span class="nx">aix</span><span class="p">.</span><span class="nx">setPublicKey</span><span class="p">(</span><span class="nx">publicKey</span><span class="p">);</span>
      <span class="nx">aix</span><span class="p">.</span><span class="nx">setHostName</span><span class="p">(</span><span class="nx">hostName</span><span class="p">);</span>

      <span class="nx">aix</span><span class="p">.</span><span class="nx">getTransactionToken</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
              <span class="c1">// Neste modo, o token deve ser enviado </span>
              <span class="c1">// junto com o POST do pagamento em um </span>
              <span class="c1">// atributo chamado checkoutSessionToken</span>
          <span class="p">}</span>
      <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
      <span class="p">});</span>
  <span class="p">}</span>
<span class="o">&lt;</span><span class="sr">/script</span><span class="err">&gt;
</span>
<span class="c1">// exemplo de submit do submit do formulário, </span>
<span class="c1">// utilizando requisição AJAX para envio dos dados.</span>
<span class="kd">function</span> <span class="nx">onSubmit</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="na">dadosAdicionais</span><span class="p">:</span> <span class="s1">'Descricao do pagamento'</span><span class="p">,</span>
        <span class="na">valor</span><span class="p">:</span> <span class="mf">150.30</span><span class="p">,</span>
        <span class="na">parcelas</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="na">bandeira</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="na">cartao</span><span class="p">:</span> <span class="nx">aix</span><span class="p">.</span><span class="nx">encryptValue</span><span class="p">(</span><span class="s1">'1234567890123456'</span><span class="p">),</span>
        <span class="na">validade</span><span class="p">:</span> <span class="nx">aix</span><span class="p">.</span><span class="nx">encryptValue</span><span class="p">(</span><span class="s1">'10/2023'</span><span class="p">),</span>
        <span class="na">cvv</span><span class="p">:</span> <span class="nx">aix</span><span class="p">.</span><span class="nx">encryptValue</span><span class="p">(</span><span class="s1">'1234'</span><span class="p">),</span>
        <span class="na">portador</span><span class="p">:</span> <span class="s1">'Jorge da Silva'</span><span class="p">,</span>
        <span class="na">cpfCnpjPortador</span><span class="p">:</span> <span class="s1">'11111111111'</span><span class="p">,</span>
        <span class="na">checkoutSessionToken</span><span class="p">:</span> <span class="nx">token</span> <span class="c1">// token obtido da promise aix.createEncryptedForm()</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
    <span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s1">'POST'</span><span class="p">,</span> <span class="s1">'my-custom-endpoint-url'</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="nx">xhr</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s1">'Content-type'</span><span class="p">,</span> <span class="s1">'application/json'</span><span class="p">);</span>
    <span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">));</span>
<span class="p">}</span>
</code></pre>
<p>Este método é adequado para sites desenvolvidos utilizando bibliotecas ou frameworks que interceptam o evento de submit do formulário e realizam o submit de forma própria e também se utilizam de bindings ou funções para obter dados digitados no formulário.</p>
<h3 id='inicializacao'>Inicialização</h3>
<p>A biblioteca deve ser inicializada no evento de load da página pois executa uma chamada assíncrona para os servidores da <span class="aixmobil">AixMobil</span> a fim de validar a autenticidade do formulário de pagamento.</p>

<p>A chave pública e o hostname do backend devem ser informados antes da chamada para a validação do formulário.</p>

<p>Neste modo, é necessário chamar a função <code>aix.getTransactionToken()</code> para que um novo token seja gerado e enviado posteriormente junto com os dados do pagamento.</p>
<h3 id='envio-dos-dados'>Envio dos dados</h3>
<p>Antes de submeter os dados, deve-se utilizar a função <code>aix.encryptValue()</code> para encriptar cada um dos campos abaixo:</p>

<ul>
<li>número do cartão (crédito/débito)</li>
<li>CVV</li>
<li>data de expiração do cartão</li>
</ul>

<aside class="warning">
  Para o ambiente de testes, pode-se utilizar sites que geram números aleatórios de cartão e utilizar um número de cartão com final 1.
</aside>

<aside class="warning">
  É importante que os campos citados acima sejam entregues de forma encriptada para a API da <span class="aixmobil">AixMobil</span> ou a transação não concluirá com sucesso.
</aside>

<p>É neste momento que o token gerado no início da página é enviado junto com os dados da requisição utilizando a propridade <code>checkoutSessionToken</code>.</p>
<h2 id='submit-com-atributo-action-e-method'>Submit com atributo action e method</h2><pre class="highlight javascript tab-javascript"><code><span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span>
  <span class="nb">window</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">publicKey</span> <span class="o">=</span> <span class="s1">'[CHAVE_PUBLICA_AQUI]'</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">hostName</span> <span class="o">=</span> <span class="s1">'[HOST_NAME_DO_SERVICO_AQUI]'</span><span class="p">;</span>

      <span class="nx">aix</span><span class="p">.</span><span class="nx">setPublicKey</span><span class="p">(</span><span class="nx">publicKey</span><span class="p">);</span>
      <span class="nx">aix</span><span class="p">.</span><span class="nx">setHostName</span><span class="p">(</span><span class="nx">hostName</span><span class="p">);</span>

      <span class="nx">aix</span><span class="p">.</span><span class="nx">createEncryptedForm</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
              <span class="c1">// um atributo contendo o valor do token deve ser enviado no body da requisição HTTP caso o submit esteja sendo feito de forma manual.</span>
              <span class="c1">// para submit feito utilizando o atributo action do form, esse valor é enviado automaticamente.</span>

              <span class="c1">// A partir deste ponto, o formulário pode ser submetido pois já possui o token necessário para validação da transação.</span>
          <span class="p">}</span>
      <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
      <span class="p">});</span>
  <span class="p">}</span>
<span class="o">&lt;</span><span class="sr">/script</span><span class="err">&gt;
</span></code></pre>
<p>Este método é adequado para sites que fazem a submissão dos dados de um formulário utilizando o atributo action e method do elemento <code>form</code>.</p>
<h3 id='inicializacao-2'>Inicialização</h3>
<p>A biblioteca deve ser inicializada no evento de load da página pois executa uma chamada assíncrona para os servidores da <span class="aixmobil">AixMobil</span> a fim de validar o formulário de pagamento.</p>

<p>A chave pública e o hostname do backend devem ser informados antes da chamada para a validação do formulário.</p>

<p>Neste modo, é necessário chamar a função <code>aix.createEncryptedForm()</code> para preparar o formulário para encriptação. Essa função também se encarrega de gerar um novo token de transação, que será enviado automaticamente ao submeter os dados, sem necessidade de código adicional.</p>
<h3 id='envio-dos-dados-2'>Envio dos dados</h3><pre class="highlight html tab-html"><code><span class="c">&lt;!-- Form notation --&gt;</span>
<span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">"POST"</span> <span class="na">data-encrypted-form=</span><span class="s">"payment-form"</span><span class="nt">&gt;</span>

<span class="c">&lt;!-- Encrypted input notation --&gt;</span>
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"tel"</span> <span class="na">data-encrypted-field=</span><span class="s">"numero"</span> <span class="nt">/&gt;</span>

<span class="c">&lt;!-- Regular input notation --&gt;</span>
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"tel"</span> <span class="na">name=</span><span class="s">"valor"</span> <span class="nt">/&gt;</span>



<span class="c">&lt;!-- Form overview --&gt;</span>
<span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">"POST"</span> <span class="na">data-encrypted-form=</span><span class="s">"payment-form"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"field"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;label&gt;</span>Número do cartão<span class="nt">&lt;/label&gt;</span>
      <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"tel"</span> <span class="na">data-encrypted-field=</span><span class="s">"numero"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"field"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;label&gt;</span>Data de validade do cartão<span class="nt">&lt;/label&gt;</span>
      <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"tel"</span> <span class="na">data-encrypted-field=</span><span class="s">"dataExpiracao"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"field"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;label&gt;</span>CVV<span class="nt">&lt;/label&gt;</span>
      <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"tel"</span> <span class="na">data-encrypted-field=</span><span class="s">"codigoSeguranca"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"field"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;label&gt;</span>Portador<span class="nt">&lt;/label&gt;</span>
      <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"portador"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"field"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;label&gt;</span>Valor<span class="nt">&lt;/label&gt;</span>
      <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"tel"</span> <span class="na">name=</span><span class="s">"valor"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;button&gt;</span>Encriptar e enviar<span class="nt">&lt;/button&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</code></pre>
<p>O html do formulário e dos campos a serem encriptados devem seguir algumas regras. Dessa forma, não será necessário nenhum código para controlar a submissão dos dados.</p>

<ul>
<li><p>Incluir o atributo <code>data-encrypted-form</code> no formulário</p></li>
<li><p>Para cada um dos campos que devem ser encriptados, não utilizar o atributo <code>name</code>.</p></li>
<li><p>Para cada um dos campos que devem ser encriptados, adicionar o atributo <code>data-encrypted-field</code> e atribuindo o nome correspondente na API da <span class="aixmobil">AixMobil</span>.</p></li>
<li><p>Campos adicionais que não precisam ser encriptados podem utilizar o atributo <code>name</code> normalmente e seus dados não serão encriptados.</p></li>
</ul>
<h1 id='validacao-da-transacao'>Validação da transação</h1><pre class="highlight javascript tab-javascript"><code><span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
    <span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s1">'POST'</span><span class="p">,</span> <span class="s1">'my-custom-endpoint-url'</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="nx">xhr</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s1">'Content-type'</span><span class="p">,</span> <span class="s1">'application/json'</span><span class="p">);</span>
    <span class="nx">xhr</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">===</span> <span class="nx">XMLHttpRequest</span><span class="p">.</span><span class="nx">DONE</span> <span class="o">&amp;&amp;</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">response</span><span class="p">;</span>

        <span class="c1">// chama manualmente a geração de novo token</span>
        <span class="nx">aix</span><span class="p">.</span><span class="nx">getTransactionToken</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// armazena token para ser enviado no próximo submit</span>
        <span class="p">});</span>
      <span class="p">}</span>
    <span class="p">};</span>
    <span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">));</span>
</code></pre>
<p>A autenticação da transação se dá quando o backend confirma que o token recebido junto com os dados de pagamento equivale ao token gerado no carregamento da página.</p>

<p>A geração do token é feita de forma automática quando a função <code>aix.createEncryptedForm()</code> é chamada ou quando a função <code>aix.getTransactionToken()</code> é chamada explicitamente.</p>

<p>No entanto, dependendo da navegação do site, se o site foi desenhado para não redirecionar o usuário após um pagamento e ainda permitir que outra transação seja realizada sem que o usuário precise sair da tela e voltar ou realizar um refresh, é necessário chamar manualmente uma função para gerar um novo token, uma vez que o token anterior já foi consumido e não pode ser reutilizado.</p>

<p>Neste caso, pode-se executar a função <code>aix.getTransactionToken()</code> para gerar novo token logo após o submit do formulário ter sido realizado com sucesso.</p>

      </div>
      <div class="dark-box">
          <div class="lang-selector">
                <a href="#" data-language-name="javascript">javascript</a>
          </div>
      </div>
    </div>
  </body>
</html>
